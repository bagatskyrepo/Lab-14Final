name: Java CI with Maven & Security Scan

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Забираємо код (Task 3.1)
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Ставимо Java 17 (Task 3.1)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # 3. Проганяємо тести і білд (Task 3.1, 3.3)
    # Якщо тести впадуть — білд впаде (автоматично в Maven)
    - name: Build and Test with Maven
      run: mvn -B clean verify

    # 4. Перевірка безпеки OWASP
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'lab14-server'
        path: '.'
        format: 'HTML'
        args: >
          --failOnCVSS 7

    # 5. Зберігаємо звіт JaCoCo, щоб ти міг його скачати (Task 3.2)
    - name: Upload JaCoCo Report
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-report
        path: target/site/jacoco/

    # 6. Зберігаємо звіт по безпеці OWASP (бо цікаво ж, що воно знайшло)
    - name: Upload OWASP Report
      uses: actions/upload-artifact@v4
      with:
        name: owasp-report
        path: reports/dependency-check-report.html